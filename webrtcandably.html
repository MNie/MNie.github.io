<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MNie | Signaling in WebRTC with Ably and Fable</title>
  <meta name="description" content="Implement simple WebRTC signaling mechanism via Ably.io.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Signaling in WebRTC with Ably and Fable">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://mnie.me/webrtcandably">
  <meta property="og:description" content="Implement simple WebRTC signaling mechanism via Ably.io.">
  <meta property="og:site_name" content="MNie">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://mnie.me/webrtcandably">
  <meta name="twitter:title" content="Signaling in WebRTC with Ably and Fable">
  <meta name="twitter:description" content="Implement simple WebRTC signaling mechanism via Ably.io.">

  
    
      <meta property="og:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
      <meta name="twitter:image" content="http://mnie.me/assets/documentation/sample-image-0a264584b152aa8d86f61525d05ae1131787d0a1029aa1cb7e3e4148b5d34755.jpg">
    
  

  <link href="http://mnie.me/feed.xml" type="application/rss+xml" rel="alternate" title="MNie Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-8d94e1b2ced7d843d882416da48ad6b7a0386071412905b6048dbe8205e32559.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-03c296a876e33d932966817b36fde1212bdb044fb0585145cde98ac98da59715.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-52a5e7e150abd939a150d09a93ec31ffd219b9e01c09465a899f36f3654beef1.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="MNie">MNie</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/mnie8" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/mnie" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://stackoverflow.com/users/2947860" rel="noreferrer noopener" target="_blank" title="Stack Overflow">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-stackoverflow">
  <use href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow" xlink:href="/assets/stackoverflow-12ba59133ed134d26156d30f095e0222b6039395cf26f2fab0cb6ce3ef2db00d.svg#icon-stackoverflow"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/michał-niegrzybowski" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:michal.niegrzybowski@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>Signaling in WebRTC with Ably and Fable</h1>
            <p>Implement simple WebRTC signaling mechanism via Ably.io.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    January 5, 2021
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      15 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/fsharp" title="See all posts with tag 'F#'">F#</a>
    
      
      <a href="/tag/fable" title="See all posts with tag 'Fable'">Fable</a>
    
      
      <a href="/tag/webrtc" title="See all posts with tag 'WebRTC'">WebRTC</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Hi,</p>

<p>I try to combine a WebRTC and Fable for some time in my daily work. I want to describe the process of implementing a signaling mechanism for it.</p>

<p>But at first, what is a WebRTC? <a href="https://webrtc.org/">WebRTC</a> is a technology that allows exchanging data between N peers via UDP or TCP protocols.
Exchange means that there is no server in the middle, but peers talk to each other (except situation when Relay connection is used). WebRTC is a native API available in all modern browsers. One of the things that are not ready by default is the signaling process. About which will be this article.</p>

<p>Before we go into details of implementation. Let’s explain some basic concepts around signaling. To establish a connection between 2 Peers they need to exchange messages with <a href="https://developer.mozilla.org/en-US/docs/Glossary/SDP">SDP</a> (Session description protocol) information. The number of those messages depends on:</p>

<ul>
  <li>the number of STUN/TURN server,</li>
  <li>type of connection (P2P/Relay).</li>
</ul>

<p>SDP contains a lot of information needed to start a connection. Messages that would be exchanged are called Offer, Answer, and Candidates. We gonna use a <a href="https://webrtcglossary.com/trickle-ice/">Trickle-Ice</a> mechanism. It means that the offer, answer, and candidates will be sent separately in an async manner. Candidates have information about “how to connect to a peer which create them” (more about them <a href="https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate">here</a>). There is also a simpler way of establishing a connection where Answer and Offer would contain all needed candidates. But I want to focus on an async version because we are using it in our product because of better performance.</p>

<p>Switching messages as described above are named “signaling”. When I was looking for some ready to go solution for signaling I find out <a href="https://www.ably.io/">Ably.io</a>. I decided to give it a try in case of my base application, which should send a file from one peer to another.</p>

<p>When I was reading the Ably.io documentation. I realized that the only functions that I will need would be <code class="highlighter-rouge">publish</code> and <code class="highlighter-rouge">subscribe</code>. Which are used in a message channel context. Because of that, I created an Ably interface in F# which is a port of JS interfaces from their official lib.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">AblyMapping</span> <span class="p">=</span>
  <span class="k">type</span> <span class="nc">IMessage</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span>
    <span class="k">abstract</span> <span class="n">data</span><span class="p">:</span> <span class="kt">string</span>

  <span class="k">type</span> <span class="nc">IChannel</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="n">publish</span><span class="p">:</span> <span class="kt">string</span> <span class="p">*</span> <span class="kt">string</span> <span class="p">-&gt;</span> <span class="kt">unit</span>
    <span class="k">abstract</span> <span class="n">subscribe</span><span class="p">:</span> <span class="kt">string</span> <span class="p">*</span> <span class="p">(</span><span class="nc">IMessage</span> <span class="p">-&gt;</span> <span class="kt">unit</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="kt">unit</span>

  <span class="k">type</span> <span class="nc">IChannels</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="n">``get``</span><span class="p">:</span> <span class="kt">string</span> <span class="p">-&gt;</span> <span class="nc">IChannel</span>

  <span class="k">type</span> <span class="nc">IRealTime</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="n">channels</span><span class="p">:</span> <span class="nc">IChannels</span>

  <span class="k">type</span> <span class="nc">IAbly</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="nc">Realtime</span><span class="p">:</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">IRealTime</span>

  <span class="k">let</span> <span class="nc">Ably</span><span class="p">:</span> <span class="nc">IAbly</span> <span class="p">=</span> <span class="n">importAll</span> <span class="s2">"Ably"</span></code></pre></figure>

<p>Changes in packages.json.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="err">…</span>
  <span class="err">”</span><span class="nx">ably</span><span class="err">”</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^1.2.4</span><span class="dl">"</span>
<span class="p">}</span></code></pre></figure>

<p>I believe that the above code is self-explanatory when we look at the JS example from the Ably site.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">ably</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ably</span><span class="p">.</span><span class="nx">Realtime</span><span class="p">(</span><span class="dl">'</span><span class="s1">apikey</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">ably</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">gut-tub</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Publish a message to the gut-tub channel</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="dl">'</span><span class="s1">greeting</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ably</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ably</span><span class="p">.</span><span class="nx">Realtime</span><span class="p">(</span><span class="dl">'</span><span class="s1">apikey</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">ably</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">gut-tub</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Subscribe to messages on channel</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">greeting</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>Initialization of ably could be found in <code class="highlighter-rouge">init</code> method.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="bp">()</span><span class="p">:</span> <span class="nc">Model</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="p">=</span>
    <span class="nn">AblyMapping</span><span class="p">.</span><span class="nn">Ably</span><span class="p">.</span><span class="nc">Realtime</span> <span class="err">“</span><span class="n">api</span><span class="p">-</span><span class="n">key</span><span class="err">”</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">channels</span><span class="p">.</span><span class="n">get</span> <span class="err">“</span><span class="n">channel</span> <span class="n">name</span><span class="s2">"
  let model = {
    Role = None
    Channel = channel
    ConnectionState = WebRTC.ConnectionState.NotConnected
    WaitingCandidates = [] }
  model, Cmd.none</span></code></pre></figure>

<p>Right now, we could go to sending and receiving messages via Ably, but I start with installing the <a href="https://www.npmjs.com/package/webrtc-adapter">WebRTC-adapter</a> library. This library gives me confidence that what I want to achieve with native API would work the same way in every browser. Since there are some slight differences between implementations.</p>

<p>I add the following line to the packages.json with the <code class="highlighter-rouge">webrtc-adapter</code> library.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="err">…</span>
  <span class="dl">"</span><span class="s2">webrtc-adapter</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^7.7.0</span><span class="dl">"</span>
<span class="p">}</span></code></pre></figure>

<p>Usage in F# code.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">WebRTC</span> <span class="p">=</span>
  <span class="k">let</span> <span class="k">private</span> <span class="n">adapter</span><span class="p">:</span> <span class="n">obj</span> <span class="p">=</span> <span class="n">importAll</span> <span class="s2">"webrtc-adapter"</span></code></pre></figure>

<p>Thanks to the above. I’m sure that the interfaces are compatible across all supported browsers. We could switch to the code which is responsible for handling WebRTC. The code snippet is big because we need to distinguish the <code class="highlighter-rouge">sender</code> and <code class="highlighter-rouge">receiver</code> of a file. It is because we don’t have an application on the server-side. I started with the creation of a <code class="highlighter-rouge">PeerConnection</code> object with a communication server address.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">create</span> <span class="bp">()</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">conf</span> <span class="p">=</span>
    <span class="p">[|</span> <span class="nn">RTCIceServer</span><span class="p">.</span><span class="nc">Create</span><span class="p">(</span> <span class="p">[|</span> <span class="s2">"turn:location:443"</span> <span class="o">|],</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"pass"</span><span class="p">,</span> <span class="nn">RTCIceCredentialType</span><span class="p">.</span><span class="nc">Password</span> <span class="p">)</span> <span class="p">|]</span>
    <span class="p">|&gt;</span> <span class="nn">RTCConfiguration</span><span class="p">.</span><span class="nc">Create</span>
    <span class="p">|&gt;</span> <span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
      <span class="n">x</span><span class="p">.</span><span class="n">iceTransportPolicy</span> <span class="p">&lt;-</span> <span class="nc">Some</span> <span class="nn">RTCIceTransportPolicy</span><span class="p">.</span><span class="nc">Relay</span>
      <span class="n">x</span>

    <span class="k">let</span> <span class="n">pc</span> <span class="p">=</span> <span class="nn">RTCPeerConnection</span><span class="p">.</span><span class="nc">Create</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>

    <span class="p">{</span> <span class="nc">Peer</span> <span class="p">=</span> <span class="n">pc</span><span class="p">;</span> <span class="nc">Channel</span> <span class="p">=</span> <span class="nc">None</span> <span class="p">}</span></code></pre></figure>

<p>Because I test everything locally, I force using a Relay connection. Otherwise, communication would be done via a local network. That would result in skipping the signaling phase (host candidates would be used). Worth mentioning is that using public STUN/TURN servers is not recommended. We are not sure how the configuration looks like and who owns them.</p>

<p>We create a <code class="highlighter-rouge">LifecycleModel</code> object which contains a <code class="highlighter-rouge">PeerConnection</code> and <code class="highlighter-rouge">RTCDataChannel</code> inside. And create an instance of it. It is created as a mutable field instead of part of the Elmish model. It is because of simplicity (default Thoth serializer couldn’t handle serializing <code class="highlighter-rouge">PeerConnection</code> also passing the whole big object wouldn’t be something that we want to do).</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">LifecycleModel</span> <span class="p">=</span> <span class="p">{</span>
  <span class="nc">Peer</span><span class="p">:</span> <span class="nc">RTCPeerConnection</span>
  <span class="nc">Channel</span><span class="p">:</span> <span class="nc">RTCDataChannel</span> <span class="n">option</span>
<span class="p">}</span>

<span class="o">...</span>

<span class="k">let</span> <span class="k">mutable</span> <span class="n">peer</span><span class="p">:</span> <span class="nc">LifecycleModel</span> <span class="p">=</span> <span class="nn">Unchecked</span><span class="p">.</span><span class="n">defaultof</span><span class="o">&lt;_&gt;</span>

<span class="o">...</span>

<span class="n">peer</span> <span class="p">&lt;-</span> <span class="nn">WebRTC</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span></code></pre></figure>

<p>After the creation of the <code class="highlighter-rouge">PeerConnection</code> object. We see that in the UI we have a possibility to connect as <code class="highlighter-rouge">sender</code> or <code class="highlighter-rouge">receiver</code>.</p>

<p><img src="https://mnie.github.com/img/2021_01_05_webrtc_ably/initialize.png" alt="initialize" /></p>

<p>It would result in a distinction of how WebRTC is working and a different value for a <code class="highlighter-rouge">Role</code> field in a model. When we look at how the <code class="highlighter-rouge">sender</code> logic is implemented we start with the creation of <code class="highlighter-rouge">RTCDataChannel</code>. It would be used as a transfer channel between users. The creation of a channel is located in the <code class="highlighter-rouge">createChannel</code> function.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">createChannel</span> <span class="n">pc</span> <span class="n">name</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="p">=</span> <span class="n">pc</span><span class="p">.</span><span class="nn">Peer</span><span class="p">.</span><span class="n">createDataChannel</span> <span class="n">name</span>
  <span class="p">{</span> <span class="n">pc</span> <span class="k">with</span> <span class="nc">Channel</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">channel</span><span class="p">}</span></code></pre></figure>

<p>Going to the configuration of messages send and received via <code class="highlighter-rouge">Ably</code>. When we are a <code class="highlighter-rouge">sender</code> we want to listen to <code class="highlighter-rouge">Answer</code> and <code class="highlighter-rouge">Candidate</code>(from the receiver) messages. How it is achieved is visible in below code snippet.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">subs</span> <span class="p">=</span>
  <span class="p">[</span>
      <span class="s2">"answer"</span><span class="p">,</span> <span class="k">fun</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nn">AblyMapping</span><span class="p">.</span><span class="nc">IMessage</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">dispatch</span> <span class="p">(</span><span class="nn">Msg</span><span class="p">.</span><span class="nc">WebRTC</span> <span class="p">(</span><span class="nn">WebRTC</span><span class="p">.</span><span class="nn">Msg</span><span class="p">.</span><span class="nc">Answer</span> <span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="o">))</span>
      <span class="s2">"receiver-candidate"</span><span class="p">,</span> <span class="k">fun</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nn">AblyMapping</span><span class="p">.</span><span class="nc">IMessage</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">dispatch</span> <span class="p">(</span><span class="nn">Msg</span><span class="p">.</span><span class="nc">WebRTC</span> <span class="p">(</span><span class="nn">WebRTC</span><span class="p">.</span><span class="nn">Msg</span><span class="p">.</span><span class="nc">Candidate</span> <span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="o">))</span>
  <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span></code></pre></figure>

<p>And combination with <code class="highlighter-rouge">Ably</code> channel is visible in <code class="highlighter-rouge">init</code> method from <code class="highlighter-rouge">Signaling</code> module.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="nc">IChannel</span><span class="p">)</span> <span class="p">(</span><span class="n">subscribers</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="nc">IMessage</span> <span class="p">-&gt;</span> <span class="kt">unit</span><span class="o">&gt;)</span> <span class="p">=</span>
  <span class="n">subscribers</span>
  <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">subscriberKey</span> <span class="n">subscriberFunc</span> <span class="p">-&gt;</span>
      <span class="n">channel</span><span class="p">.</span><span class="n">subscribe</span> <span class="p">(</span><span class="n">subscriberKey</span><span class="p">,</span> <span class="n">subscriberFunc</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="n">channel</span></code></pre></figure>

<p>As we could see we subscribe to all messages with the given keys <code class="highlighter-rouge">answer</code> and <code class="highlighter-rouge">receiver-candidate</code>. When they occur we propagate Elmish messages that would be handle in the <code class="highlighter-rouge">update</code> method.</p>

<p>In the <code class="highlighter-rouge">receiver</code> scenario the difference is that we don’t create <code class="highlighter-rouge">RTCDataChannel</code> (this is why it is marked as <code class="highlighter-rouge">option</code> in <code class="highlighter-rouge">LifecycleModel</code>). We gather it when the connection would be in a <code class="highlighter-rouge">connecting</code> phase. If it would be created on its own we would receive an invalid state error.
This is why we only subscribe to messages <code class="highlighter-rouge">Offer</code> and <code class="highlighter-rouge">Candidate</code>(from Sender).</p>

<p>When a subscription to Ably messages is ready we send an Elmish message <code class="highlighter-rouge">Signaling</code> with a ready channel which is updated in the application model. Whereas the WebRTC configuration is updated with callbacks to functions that need to be handled in a connection/data transfer process.</p>

<p>Assignment of those callbacks and how they are handled is visible in a <code class="highlighter-rouge">subscribe</code> function.
Which should:</p>

<ul>
  <li>Initialize <code class="highlighter-rouge">RTCDataChannel</code> through which data (file) would be transferred.</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="k">private</span> <span class="n">initReceiverChannel</span> <span class="p">(</span><span class="n">pc</span><span class="p">:</span> <span class="nc">RTCPeerConnection</span><span class="p">)</span> <span class="n">msgHandler</span> <span class="n">dispatch</span> <span class="p">=</span>
  <span class="k">let</span> <span class="k">mutable</span> <span class="n">updatedChannel</span><span class="p">:</span> <span class="nc">RTCDataChannel</span> <span class="p">=</span> <span class="nn">Unchecked</span><span class="p">.</span><span class="n">defaultof</span><span class="o">&lt;_&gt;</span>
  <span class="k">let</span> <span class="n">callback</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">RTCDataChannelEvent</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">receiveChannel</span> <span class="p">=</span> <span class="n">subscribeChannel</span> <span class="n">ev</span><span class="p">.</span><span class="n">channel</span> <span class="n">msgHandler</span> <span class="n">dispatch</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"updating channel: %A"</span> <span class="n">ev</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">peer</span> <span class="p">&lt;-</span> <span class="p">{</span> <span class="n">peer</span> <span class="k">with</span> <span class="nc">Channel</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">receiveChannel</span> <span class="p">}</span>

  <span class="n">pc</span><span class="p">.</span><span class="n">ondatachannel</span> <span class="p">&lt;-</span> <span class="n">callback</span>
  <span class="n">updatedChannel</span>

<span class="k">let</span> <span class="n">updatedChannel</span> <span class="p">=</span>
  <span class="k">if</span> <span class="n">role</span> <span class="p">=</span> <span class="nn">Role</span><span class="p">.</span><span class="nc">Sender</span> <span class="k">then</span>
    <span class="k">match</span> <span class="n">channel</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="p">-&gt;</span>
      <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"initialize channel for: %A"</span> <span class="n">role</span><span class="p">)</span>
      <span class="n">subscribeChannel</span> <span class="n">c</span> <span class="n">msgHandler</span> <span class="n">dispatch</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Channel is not initilized for sender"</span>
  <span class="k">else</span>
      <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"initialize channel2 for: %A"</span> <span class="n">role</span><span class="p">)</span>
      <span class="n">initReceiverChannel</span> <span class="n">pc</span> <span class="n">msgHandler</span> <span class="n">dispatch</span></code></pre></figure>

<ul>
  <li>Handling connection state (only for diagnostic purposes).</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">pc</span><span class="p">.</span><span class="n">oniceconnectionstatechange</span> <span class="p">&lt;-</span>
  <span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Connection state changed to: %A"</span> <span class="n">pc</span><span class="p">.</span><span class="n">iceConnectionState</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>Handling exchange of candidates.</li>
</ul>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">pc</span><span class="p">.</span><span class="n">onicecandidate</span> <span class="p">&lt;-</span>
  <span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>
    <span class="k">match</span> <span class="n">e</span><span class="p">.</span><span class="n">candidate</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">internalLog</span> <span class="s2">"Trickle ICE Completed"</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">cand</span> <span class="p">-&gt;</span>
      <span class="n">cand</span><span class="p">.</span><span class="n">toJSON</span><span class="bp">()</span>
      <span class="p">|&gt;</span> <span class="nn">Base64</span><span class="p">.</span><span class="n">``to``</span>
      <span class="p">|&gt;</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">WebRTCCandidate</span><span class="p">.</span><span class="nc">Candidate</span>
      <span class="p">|&gt;</span>
        <span class="k">if</span> <span class="n">role</span> <span class="p">=</span> <span class="nn">Role</span><span class="p">.</span><span class="nc">Sender</span> <span class="k">then</span>
            <span class="nn">Signaling</span><span class="p">.</span><span class="nn">Notification</span><span class="p">.</span><span class="nc">SenderCandidate</span>
        <span class="k">else</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">Notification</span><span class="p">.</span><span class="nc">ReceiverCandidate</span>
      <span class="p">|&gt;</span> <span class="n">onSignal</span></code></pre></figure>

<p>Configuration of WebRTC is ready on the <code class="highlighter-rouge">sender</code> and <code class="highlighter-rouge">receiver</code> side.</p>

<p><img src="https://mnie.github.com/img/2021_01_05_webrtc_ably/connect.png" alt="connect" /></p>

<p>We could initiate a connection by clicking the <code class="highlighter-rouge">Connect</code> button. After clicking it the <code class="highlighter-rouge">init</code> method from the <code class="highlighter-rouge">WebRTC</code> module would be called.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="n">connection</span> <span class="n">onSignal</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">pc</span><span class="p">,</span> <span class="n">channel</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="nc">Peer</span><span class="p">,</span> <span class="n">connection</span><span class="p">.</span><span class="nc">Channel</span>
  <span class="n">pc</span><span class="p">.</span><span class="n">createOffer</span><span class="bp">()</span><span class="p">.</span><span class="n">``then``</span><span class="p">(</span><span class="k">fun</span> <span class="n">desc</span> <span class="p">-&gt;</span>
    <span class="n">pc</span><span class="p">.</span><span class="n">setLocalDescription</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>
    <span class="k">if</span> <span class="n">isNull</span> <span class="n">desc</span><span class="p">.</span><span class="n">sdp</span> <span class="k">then</span>
      <span class="n">internalLog</span> <span class="s2">"Local description is empty"</span>
    <span class="k">else</span>
      <span class="n">desc</span>
      <span class="p">|&gt;</span> <span class="nn">Base64</span><span class="p">.</span><span class="n">``to``</span>
      <span class="p">|&gt;</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">WebRTCOffer</span><span class="p">.</span><span class="nc">Offer</span>
      <span class="p">|&gt;</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">Notification</span><span class="p">.</span><span class="nc">Offer</span>
      <span class="p">|&gt;</span> <span class="n">onSignal</span><span class="p">)</span>

  <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">catch</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"On negotation needed return error: %A"</span> <span class="o">&gt;&gt;</span> <span class="n">internalLog</span><span class="p">)</span>
  <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>

  <span class="p">{</span> <span class="nc">Peer</span> <span class="p">=</span> <span class="n">pc</span>
    <span class="nc">Channel</span> <span class="p">=</span> <span class="n">channel</span> <span class="p">}</span></code></pre></figure>

<p>We send <code class="highlighter-rouge">Offer</code> via Ably channel and set it as <code class="highlighter-rouge">LocalDescription</code> via <code class="highlighter-rouge">setLocalDescription</code> method on <code class="highlighter-rouge">PeerConnection</code> object. Right now the application flow is not visible when we look at the code at first. The other side of communication should receive <code class="highlighter-rouge">Offer</code> via Ably channel which would be then propagated as <code class="highlighter-rouge">Offer</code> Elmish message and handle in <code class="highlighter-rouge">update</code> method.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">setOffer</span> <span class="p">(</span><span class="n">lifecycle</span><span class="p">:</span> <span class="nc">LifecycleModel</span><span class="p">)</span> <span class="n">onSignal</span> <span class="n">remote</span> <span class="p">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">desc</span> <span class="p">=</span> <span class="n">rtcSessionDescription</span> <span class="n">remote</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"setting offer: %A"</span> <span class="n">desc</span><span class="p">)</span>
    <span class="n">lifecycle</span><span class="p">.</span><span class="nn">Peer</span><span class="p">.</span><span class="n">setRemoteDescription</span> <span class="n">desc</span>
    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">catch</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Failed to set remote description: %A"</span> <span class="o">&gt;&gt;</span> <span class="n">internalLog</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>
    <span class="n">lifecycle</span><span class="p">.</span><span class="nn">Peer</span><span class="p">.</span><span class="n">createAnswer</span><span class="bp">()</span><span class="p">.</span><span class="n">``then``</span><span class="p">(</span><span class="k">fun</span> <span class="n">desc</span> <span class="p">-&gt;</span>
      <span class="n">lifecycle</span><span class="p">.</span><span class="nn">Peer</span><span class="p">.</span><span class="n">setLocalDescription</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>
      <span class="k">if</span> <span class="n">isNull</span> <span class="n">desc</span><span class="p">.</span><span class="n">sdp</span> <span class="k">then</span>
        <span class="n">internalLog</span> <span class="s2">"Local description is empty"</span>
      <span class="k">else</span>
        <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"sending answer: %A"</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">desc</span>
        <span class="p">|&gt;</span> <span class="nn">Base64</span><span class="p">.</span><span class="n">``to``</span>
        <span class="p">|&gt;</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">WebRTCAnswer</span><span class="p">.</span><span class="nc">Answer</span>
        <span class="p">|&gt;</span> <span class="nn">Signaling</span><span class="p">.</span><span class="nn">Notification</span><span class="p">.</span><span class="nc">Answer</span>
        <span class="p">|&gt;</span> <span class="n">onSignal</span><span class="p">)</span>

    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">catch</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"On negotation needed errored with: %A"</span> <span class="o">&gt;&gt;</span> <span class="n">internalLog</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>
  <span class="k">with</span> <span class="n">e</span> <span class="p">-&gt;</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Error occured while adding remote description: %A"</span> <span class="n">e</span><span class="p">)</span></code></pre></figure>

<p>It should set <code class="highlighter-rouge">Offer</code> from a <code class="highlighter-rouge">sender</code> as a <code class="highlighter-rouge">RemoteDescription</code> on a <code class="highlighter-rouge">receiver</code> side and in case of success generate <code class="highlighter-rouge">Answer</code>. It would be sent to the <code class="highlighter-rouge">sender</code> via Ably. The important thing to mention here is that after the creation of <code class="highlighter-rouge">Offer</code>/<code class="highlighter-rouge">Answer</code> <code class="highlighter-rouge">Candidates</code> are generated. They shouldn’t be set on the <code class="highlighter-rouge">PeerConnection</code> object before setting <code class="highlighter-rouge">Local</code> and <code class="highlighter-rouge">Remote</code> descriptions. Because of that Elmish model has a buffer for <code class="highlighter-rouge">Candidates</code> that could be received before setting <code class="highlighter-rouge">Remote</code>/<code class="highlighter-rouge">Local</code> descriptions.</p>

<p>Buffor handling:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">if</span> <span class="n">model</span><span class="p">.</span><span class="nn">WaitingCandidates</span><span class="p">.</span><span class="nc">Length</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
  <span class="n">model</span><span class="p">.</span><span class="nc">WaitingCandidates</span>
  <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="nn">WebRTC</span><span class="p">.</span><span class="n">setCandidate</span> <span class="n">peer</span> <span class="p">)</span>
  <span class="p">{</span> <span class="n">model</span> <span class="k">with</span>
              <span class="nc">ConnectionState</span> <span class="p">=</span> <span class="nn">WebRTC</span><span class="p">.</span><span class="nn">ConnectionState</span><span class="p">.</span><span class="nc">Connecting</span>
              <span class="nc">WaitingCandidates</span> <span class="p">=</span> <span class="bp">[]</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="k">else</span>
  <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">ConnectionState</span> <span class="p">=</span> <span class="nn">WebRTC</span><span class="p">.</span><span class="nn">ConnectionState</span><span class="p">.</span><span class="nc">Connecting</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Handling a message that contains <code class="highlighter-rouge">Candidates</code> looks like that.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">if</span> <span class="n">model</span><span class="p">.</span><span class="nc">ConnectionState</span> <span class="p">&lt;&gt;</span> <span class="nn">WebRTC</span><span class="p">.</span><span class="nn">ConnectionState</span><span class="p">.</span><span class="nc">NotConnected</span> <span class="k">then</span>
  <span class="nn">WebRTC</span><span class="p">.</span><span class="n">setCandidate</span> <span class="n">peer</span> <span class="n">candidate</span>
  <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="k">else</span>
  <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">WaitingCandidates</span> <span class="p">=</span> <span class="n">candidate</span><span class="p">::</span><span class="n">model</span><span class="p">.</span><span class="nc">WaitingCandidates</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p><code class="highlighter-rouge">ConnectionState</code> is set when <code class="highlighter-rouge">Offer</code> or <code class="highlighter-rouge">Answer</code> are received or when the <code class="highlighter-rouge">DataChannel</code> is open.</p>

<p>Handling <code class="highlighter-rouge">Answer</code>.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="p">|</span> <span class="nc">WebRTC</span> <span class="p">(</span><span class="nn">WebRTC</span><span class="p">.</span><span class="nn">Msg</span><span class="p">.</span><span class="nc">Answer</span> <span class="n">answer</span><span class="p">)</span> <span class="p">-&gt;</span>
  <span class="nn">WebRTC</span><span class="p">.</span><span class="n">setAnswer</span> <span class="n">peer</span> <span class="n">answer</span>
  <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">ConnectionState</span> <span class="p">=</span> <span class="nn">WebRTC</span><span class="p">.</span><span class="nn">ConnectionState</span><span class="p">.</span><span class="nc">Connecting</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Going to <code class="highlighter-rouge">setAnswer</code> implementation.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">setAnswer</span> <span class="p">(</span><span class="n">lifecycle</span><span class="p">:</span> <span class="nc">LifecycleModel</span><span class="p">)</span> <span class="n">remote</span> <span class="p">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">desc</span> <span class="p">=</span> <span class="n">rtcSessionDescription</span> <span class="n">remote</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"setting answer: %A"</span> <span class="n">desc</span><span class="p">)</span>
    <span class="n">lifecycle</span><span class="p">.</span><span class="nn">Peer</span><span class="p">.</span><span class="n">setRemoteDescription</span> <span class="n">desc</span>
    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">catch</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Failed to set remote description: %A"</span> <span class="o">&gt;&gt;</span> <span class="n">internalLog</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Promise</span><span class="p">.</span><span class="n">start</span>
  <span class="k">with</span> <span class="n">e</span> <span class="p">-&gt;</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Error occured while adding remote description: %A"</span> <span class="n">e</span><span class="p">)</span></code></pre></figure>

<p>As we could see, we only set <code class="highlighter-rouge">RemoteDescription</code> on a <code class="highlighter-rouge">PeerConnection</code> object here.</p>

<p>Right now, if everything succeeds, we should have a WebRTC connection ready. DataChannel is open between our peers. We could go to the code which is responsible for sending files. In UI, there should be a <code class="highlighter-rouge">textBox</code> that reacts on a file drop.</p>

<p><img src="https://mnie.github.com/img/2021_01_05_webrtc_ably/send.png" alt="send" /></p>

<p>Which is handled in the following way.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">Field</span><span class="p">.</span><span class="n">div</span> <span class="p">[</span>
  <span class="nn">Field</span><span class="p">.</span><span class="nc">IsGrouped</span> <span class="p">]</span> <span class="p">[</span>
  <span class="nn">Control</span><span class="p">.</span><span class="n">p</span> <span class="p">[</span> <span class="nn">Control</span><span class="p">.</span><span class="nc">IsExpanded</span> <span class="p">]</span> <span class="p">[</span>
    <span class="n">div</span> <span class="p">[</span>   
      <span class="nc">Class</span> <span class="s2">"card border-primary"</span>
      <span class="nc">Draggable</span> <span class="bp">true</span>
      <span class="nc">Style</span> <span class="p">[</span> <span class="nc">Height</span> <span class="s2">"100px"</span> <span class="p">]</span>
      <span class="nc">OnDragOver</span> <span class="p">(</span> <span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="n">e</span><span class="p">.</span><span class="n">preventDefault</span><span class="bp">()</span>
      <span class="p">)</span>
      <span class="nc">OnDrop</span> <span class="p">(</span> <span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="n">e</span><span class="p">.</span><span class="n">preventDefault</span><span class="bp">()</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">dataTransfer</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="n">length</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
          <span class="k">let</span> <span class="n">file</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">dataTransfer</span><span class="p">.</span><span class="n">files</span><span class="o">.[</span><span class="mi">0</span><span class="p">]</span>
          <span class="p">{</span> <span class="nc">Name</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="nc">Data</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">slice</span> <span class="bp">()</span> <span class="p">}</span>
          <span class="p">|&gt;</span> <span class="nc">SendFile</span>
          <span class="p">|&gt;</span> <span class="n">dispatch</span>
      <span class="p">)</span>
    <span class="p">]</span> <span class="bp">[]</span>
  <span class="p">]</span>
<span class="p">]</span></code></pre></figure>

<p><code class="highlighter-rouge">SendFile</code> message handling.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="p">|</span> <span class="nc">SendFile</span> <span class="n">file</span> <span class="p">-&gt;</span>
  <span class="nn">MessageTransfer</span><span class="p">.</span><span class="n">send</span> <span class="n">peer</span> <span class="p">(</span><span class="nn">ChannelMessage</span><span class="p">.</span><span class="nc">File</span> <span class="n">file</span><span class="p">.</span><span class="nc">Data</span><span class="p">)</span>
  <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Method <code class="highlighter-rouge">send</code> in <code class="highlighter-rouge">MessageTransfer</code>.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">send</span> <span class="p">(</span><span class="n">lifecycle</span><span class="p">:</span> <span class="nc">LifecycleModel</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">ChannelMessage</span><span class="p">)</span> <span class="p">=</span>
  <span class="k">match</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nc">Channel</span> <span class="k">with</span>
  <span class="p">|</span> <span class="nc">File</span> <span class="n">blob</span><span class="p">,</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="p">-&gt;</span>
    <span class="n">blob</span>
    <span class="p">|&gt;</span> <span class="nn">U4</span><span class="p">.</span><span class="nc">Case2</span>
    <span class="p">|&gt;</span> <span class="n">channel</span><span class="p">.</span><span class="n">send</span>
  <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">log</span> <span class="s2">"MessageTransfer"</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to process: %A channel is: %A"</span> <span class="n">msg</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nc">Channel</span><span class="p">)</span></code></pre></figure>

<p>On a <code class="highlighter-rouge">receiver</code> side <code class="highlighter-rouge">onmessage</code> handling on <code class="highlighter-rouge">DataChannel</code> object looks as follows.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">channel</span><span class="p">.</span><span class="n">onmessage</span> <span class="p">&lt;-</span>
  <span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>
    <span class="n">internalLog</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"received msg in channel: %A"</span> <span class="n">e</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">blob</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">data</span> <span class="o">:?&gt;</span> <span class="nc">Blob</span>
    <span class="n">msgHandler</span> <span class="n">blob</span></code></pre></figure>

<p>As we could see, just for simplicity we assume that only javascript <code class="highlighter-rouge">blob</code> would be sent via <code class="highlighter-rouge">DataChannel</code>. We pass there also a <code class="highlighter-rouge">msgHandler</code> which is implemented in the following way.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">download</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nc">Blob</span><span class="p">)</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">url</span> <span class="p">=</span> <span class="nn">Browser</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="nn">URL</span><span class="p">.</span><span class="n">createObjectURL</span> <span class="n">data</span>
  <span class="k">let</span> <span class="k">mutable</span> <span class="n">anchor</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">createElement</span> <span class="s2">"a"</span>
  <span class="n">anchor</span><span class="p">.</span><span class="n">hidden</span> <span class="p">&lt;-</span> <span class="bp">true</span>
  <span class="n">anchor</span><span class="p">.</span><span class="n">setAttribute</span> <span class="p">(</span><span class="s2">"href"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
  <span class="n">anchor</span><span class="p">.</span><span class="n">setAttribute</span> <span class="p">(</span><span class="s2">"download"</span><span class="p">,</span> <span class="s2">"image.png"</span><span class="p">)</span>
  <span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">appendChild</span> <span class="n">anchor</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
  <span class="n">anchor</span><span class="p">.</span><span class="n">click</span> <span class="bp">()</span>
  <span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">removeChild</span> <span class="n">anchor</span> <span class="p">|&gt;</span> <span class="n">ignore</span></code></pre></figure>

<p>Its responsibility is to receive a <code class="highlighter-rouge">FileBlob</code> and immediately download it. We assume that the file would be always a <code class="highlighter-rouge">png</code> with the name <code class="highlighter-rouge">image</code>.</p>

<p>To sum up, thanks to the <code class="highlighter-rouge">Ably</code> platform I was able to implement <code class="highlighter-rouge">Signaling</code> in a simple way which would be worth consideration during the decision-making phase about “how to achieve Signaling in a most performant way” in my daily work. During some initial tests to compare it with standard HTTP request/response, it looks promising.</p>

<p>Another interesting thing is that a user can see how the messages/connections flow and work on the <code class="highlighter-rouge">Ably</code> dashboard. There is also an information about used quota.</p>

<p><img src="https://mnie.github.com/img/2021_01_05_webrtc_ably/chart.png" alt="chart" />
<img src="https://mnie.github.com/img/2021_01_05_webrtc_ably/quota.png" alt="quota" /></p>

<p>Because there are no built-in signaling solutions Ably is for sure an almost <code class="highlighter-rouge">ready to go</code> alternative which we could use in our scenario. I hope I would be able to compare it with other ways to do signaling in the next articles.</p>

<p><a href="https://github.com/MNie/WebRTCSignaling">Repository</a></p>

<p>I hope you enjoy it. Thanks for reading!</p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Signaling+in+WebRTC+with+Ably+and+Fable%20-%20http://mnie.me/webrtcandably%20by%20@mnie8" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://mnie.me/webrtcandably" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer scrollappear">
  <p>
    2020
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-81299349-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-81299349-1');
  </script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
